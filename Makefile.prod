# Production Makefile –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–º

.PHONY: build-prod up-prod down-prod logs-prod restart-prod backup-db restore-db

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env.prod
include .env.prod
export

# –°–±–æ—Ä–∫–∞ production –≤–µ—Ä—Å–∏–∏
build-prod:
	@echo "üöÄ –°–±–æ—Ä–∫–∞ production –≤–µ—Ä—Å–∏–∏..."
	@if [ ! -f .env.prod ]; then \
		echo "‚ùå –§–∞–π–ª .env.prod –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ env.prod.example"; \
		exit 1; \
	fi
	@./build-prod.sh

# –ó–∞–ø—É—Å–∫ production –≤–µ—Ä—Å–∏–∏
up-prod:
	@echo "üöÄ –ó–∞–ø—É—Å–∫ production –≤–µ—Ä—Å–∏–∏..."
	@docker compose -f docker-compose.prod.yml --env-file .env.prod up -d

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ production –≤–µ—Ä—Å–∏–∏
down-prod:
	@echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ production –≤–µ—Ä—Å–∏–∏..."
	@docker compose -f docker-compose.prod.yml --env-file .env.prod down

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
logs-prod:
	@docker compose -f docker-compose.prod.yml --env-file .env.prod logs -f

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ production –≤–µ—Ä—Å–∏–∏
restart-prod:
	@echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ production –≤–µ—Ä—Å–∏–∏..."
	@docker compose -f docker-compose.prod.yml --env-file .env.prod restart

# –ë—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
backup-db:
	@echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
	@mkdir -p backups
	@docker compose -f docker-compose.prod.yml --env-file .env.prod exec -T postgres pg_dump -U $$POSTGRES_USER $$POSTGRES_DB > backups/backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ backups/"

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make restore-db FILE=backups/backup_20240101_120000.sql)
restore-db:
	@if [ -z "$(FILE)" ]; then \
		echo "‚ùå –£–∫–∞–∂–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: make restore-db FILE=backups/backup_20240101_120000.sql"; \
		exit 1; \
	fi
	@echo "üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ $(FILE)..."
	@docker compose -f docker-compose.prod.yml --env-file .env.prod exec -T postgres psql -U $$POSTGRES_USER $$POSTGRES_DB < $(FILE)
	@echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
status-prod:
	@docker compose -f docker-compose.prod.yml --env-file .env.prod ps

# –û—á–∏—Å—Ç–∫–∞ (—É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ volumes)
clean-prod:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ production –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
	@docker compose -f docker-compose.prod.yml --env-file .env.prod down -v
	@echo "‚ö†Ô∏è  –í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã!"

